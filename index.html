<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MGCU Attendance Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Custom Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #10B981;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #10B981;
        }
        
        /* Smooth fade in */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .student-row:hover {
            background-color: #f9fafb;
        }

        /* Login Overlay Styling */
        #login-overlay {
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="bg-[#E16734] text-white shadow-lg sticky top-0 z-50 flex-none">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-white p-1 rounded-md overflow-hidden h-10 w-14 flex items-center justify-center">
                        <img src="https://mgcub.ac.in/images/rotate.png" alt="MGCU Logo" class="h-full w-full object-contain">
                    </div>
                    <div>
                        <h1 class="font-bold text-lg leading-tight">MGCU</h1>
                        <p class="text-xs text-white/90">Mahatma Gandhi Central University</p>
                    </div>
                </div>
                <!-- User Profile / Logout (Visible when logged in) -->
                <div id="user-nav" class="text-right hidden items-center gap-4">
                    <div class="hidden sm:block">
                        <p class="text-sm font-medium" id="user-name">User</p>
                        <p class="text-xs text-white/80" id="user-email">email@example.com</p>
                    </div>
                    <button onclick="window.showLogoutConfirmation()" class="bg-white/20 hover:bg-white/30 p-2 rounded-full transition-colors" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Login Container (Modal Overlay) -->
    <div id="login-container" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-gray-900/50 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full text-center border border-gray-100 transform scale-100 transition-transform duration-300">
            <div class="bg-orange-50 h-20 w-20 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-university text-[#E16734] text-3xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Teacher Portal Login</h2>
            <p class="text-gray-500 mb-8">Restricted access for authorized faculty only.</p>
            
            <button onclick="window.loginWithGoogle()" class="w-full flex items-center justify-center gap-3 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 font-medium py-3 px-4 rounded-xl transition-all shadow-sm hover:shadow-md group">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6" alt="Google">
                <span class="group-hover:text-gray-900">Sign in with Google</span>
            </button>
            <p id="login-error" class="text-red-500 text-sm mt-4 hidden"></p>
        </div>
    </div>

    <!-- Main Content (Always visible but blurred when logged out) -->
    <main id="app-content" class="max-w-4xl mx-auto px-4 py-8 flex-grow w-full transition-all duration-500 filter blur-sm pointer-events-none select-none overflow-y-auto">
        <div class="flex justify-end mb-2 sm:hidden">
             <p class="text-xs text-gray-500" id="current-time">Loading...</p>
        </div>

        <!-- Controls Card -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6 fade-in">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-clipboard-list text-[#E16734]"></i> Class Configuration
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Date Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-calendar text-gray-400"></i>
                        </div>
                        <input type="date" id="attendance-date" class="pl-10 block w-full rounded-lg border-gray-300 bg-gray-50 border focus:ring-[#E16734] focus:border-[#E16734] sm:text-sm p-2.5 shadow-sm">
                    </div>
                </div>

                <!-- Subject Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Subject</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-book text-gray-400"></i>
                        </div>
                        <select id="subject-select" class="pl-10 block w-full rounded-lg border-gray-300 bg-gray-50 border focus:ring-[#E16734] focus:border-[#E16734] sm:text-sm p-2.5 shadow-sm">
                            <option value="Computer Science">Computer Science</option>
                            <option value="Mathematics">Mathematics</option>
                            <option value="Physics">Physics</option>
                            <option value="English Literature">English Literature</option>
                            <option value="History">History</option>
                            <option value="Political Science">Political Science</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Sheet -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden fade-in" style="animation-delay: 0.1s;">
            <!-- Sheet Header -->
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center flex-wrap gap-4">
                <div>
                    <h3 class="text-lg font-bold text-gray-900">Student List</h3>
                    <p class="text-sm text-gray-500">Mark attendance for 30 students</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="bg-green-100 text-green-800 text-xs font-bold px-3 py-1 rounded-full border border-green-200">
                        Present: <span id="present-count">0</span>
                    </div>
                    <div class="bg-red-100 text-red-800 text-xs font-bold px-3 py-1 rounded-full border border-red-200">
                        Absent: <span id="absent-count">30</span>
                    </div>
                </div>
            </div>

            <!-- Table Header -->
            <div class="grid grid-cols-12 bg-gray-100 py-3 px-6 text-xs font-semibold text-gray-500 uppercase tracking-wider border-b border-gray-200">
                <div class="col-span-9 sm:col-span-8">Student Details</div>
                <div class="col-span-3 sm:col-span-4 text-right sm:text-center">Status</div>
            </div>

            <!-- Student Rows Container -->
            <div id="student-list-container" class="divide-y divide-gray-100 relative min-h-[200px]">
                <!-- Loading Overlay -->
                <div id="loading-overlay" class="absolute inset-0 bg-white/80 z-10 flex items-center justify-center hidden">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#E16734]"></div>
                </div>
                <!-- Rows will be injected here by JS -->
            </div>

            <!-- Footer Actions -->
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex flex-col sm:flex-row justify-between items-center gap-4">
                <button onclick="window.markAll(true)" class="text-sm text-[#E16734] hover:text-[#c05528] font-medium">
                    Mark All Present
                </button>
                <div class="flex gap-3 w-full sm:w-auto">
                    <button onclick="window.downloadCSV()" class="flex-1 sm:flex-none justify-center items-center flex gap-2 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 px-4 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm">
                        <i class="fas fa-download"></i> Export CSV
                    </button>
                    <button id="save-btn" onclick="window.saveAttendance()" class="flex-1 sm:flex-none justify-center items-center flex gap-2 bg-[#E16734] hover:bg-[#c05528] text-white px-6 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-cloud-upload-alt"></i> <span>Save Record</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Success Modal (Hidden by default) -->
    <div id="success-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black opacity-50"></div>
        <div class="bg-white rounded-lg p-6 shadow-xl z-10 max-w-sm w-full mx-4 transform transition-all scale-100">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                    <i class="fas fa-check text-green-600 text-xl"></i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900">Attendance Saved!</h3>
                <p class="text-sm text-gray-500 mt-2">
                    The attendance record for <span id="modal-date" class="font-bold"></span> has been saved to the database.
                </p>
                <div class="mt-5">
                    <button onclick="window.closeModal()" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-[#E16734] text-base font-medium text-white hover:bg-[#c05528] focus:outline-none sm:text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Logout Modal (New) -->
    <div id="confirm-logout-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black opacity-50"></div>
        <div class="bg-white rounded-lg p-6 shadow-xl z-10 max-w-sm w-full mx-4 transform transition-all scale-100">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <i class="fas fa-sign-out-alt text-red-600 text-xl"></i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900">Confirm Logout</h3>
                <p class="text-sm text-gray-500 mt-2">
                    Are you sure you want to log out?
                </p>
                <div class="mt-5 flex gap-3">
                    <button onclick="window.closeLogoutConfirmation()" type="button" class="flex-1 inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:text-sm">
                        Cancel
                    </button>
                    <button onclick="window.confirmLogout()" type="button" class="flex-1 inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:text-sm">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getFirestore, doc, setDoc, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- AUTH CONFIGURATION: EDIT HERE ---
        // Add all email addresses that are allowed to access the system
        const ALLOWED_EMAILS = [
            "teacher@mgcub.ac.in", 
            "admin@mgcub.ac.in",
            "pabitramondal2635@gmail.com",
            "another.email@gmail.com", // REPLACE with the new email
            "faculty.member@mgcub.ac.in" // REPLACE with another email if needed
        ];
        
        // ... existing firebaseConfig ...
        const firebaseConfig = {
            apiKey: "AIzaSyC_JIo87PMLA6HdUHEpwxqvDr0L8yAs0xQ",
            authDomain: "mgcub-attendence.firebaseapp.com",
            projectId: "mgcub-attendence",
            storageBucket: "mgcub-attendence.firebasestorage.app",
            messagingSenderId: "1078820995602", 
            appId: "1:1078820995602:web:0533bb30794f2237ff4ecb",
            measurementId: "G-01LZJFL597"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null;

        // --- DOM Elements for Auth ---
        const loginContainer = document.getElementById('login-container');
        const confirmLogoutModal = document.getElementById('confirm-logout-modal');
        const appContent = document.getElementById('app-content');
        const userNav = document.getElementById('user-nav');
        const userNameEl = document.getElementById('user-name');
        const userEmailEl = document.getElementById('user-email');
        const loginErrorEl = document.getElementById('login-error');

        // --- Authentication Logic ---

        window.showLogoutConfirmation = function() {
            confirmLogoutModal.classList.remove('hidden');
        }

        window.closeLogoutConfirmation = function() {
            confirmLogoutModal.classList.add('hidden');
        }

        window.confirmLogout = function() {
            window.closeLogoutConfirmation();
            window.logout();
        }

        window.loginWithGoogle = async function() {
            loginErrorEl.classList.add('hidden');
            try {
                // Using signInWithPopup for modal-like authentication window
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                if (ALLOWED_EMAILS.includes(user.email)) {
                    // Success is handled by onAuthStateChanged
                    console.log("Login successful");
                } else {
                    // Unauthorized
                    await signOut(auth);
                    loginErrorEl.textContent = `Access Denied: ${user.email} is not authorized.`;
                    loginErrorEl.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Login Failed:", error);
                loginErrorEl.textContent = "Login failed. Please try again.";
                loginErrorEl.classList.remove('hidden');
            }
        };

        window.logout = function() {
            signOut(auth).then(() => {
                // UI update handled by onAuthStateChanged
            }).catch((error) => {
                console.error("Logout Error:", error);
            });
        };

        onAuthStateChanged(auth, (user) => {
            if (user && ALLOWED_EMAILS.includes(user.email)) {
                // User is logged in AND authorized
                currentUser = user;
                
                // Hide Login Modal
                loginContainer.classList.add('hidden');
                
                // Unblur App Content
                appContent.classList.remove('filter', 'blur-sm', 'pointer-events-none', 'select-none');
                document.body.classList.remove('overflow-hidden');
                
                userNav.classList.replace('hidden', 'flex'); // Show user info
                
                // Update Profile Info
                userNameEl.textContent = user.displayName;
                userEmailEl.textContent = user.email;

                loadAttendance(); // Load data
            } else {
                // User is not logged in OR is unauthorized
                currentUser = null;
                
                // Show Login Modal
                loginContainer.classList.remove('hidden');
                
                // Blur App Content
                appContent.classList.add('filter', 'blur-sm', 'pointer-events-none', 'select-none');
                document.body.classList.add('overflow-hidden');
                
                userNav.classList.replace('flex', 'hidden');
            }
        });

        // --- Data Definitions ---
        const initialStudents = [
            { id: "MGCU2023CSIT3001", name: "AADIL LATIF", present: false },
            { id: "MGCU2023CSIT3002", name: "ADITYA PRATAP SINGH", present: false },
            { id: "MGCU2023CSIT3003", name: "AJAIN RAJ PRASHAR", present: false },
            { id: "MGCU2023CSIT3004", name: "AKASH", present: false },
            { id: "MGCU2023CSIT3005", name: "ALOK JAISWAL", present: false },
            { id: "MGCU2023CSIT3006", name: "ALOK MEHTA", present: false },
            { id: "MGCU2023CSIT3007", name: "ASHISH KUMAR1", present: false },
            { id: "MGCU2023CSIT3008", name: "ASHISH KUMAR2", present: false },
            { id: "MGCU2023CSIT3009", name: "AYUSH PANDEY", present: false },
            { id: "MGCU2023CSIT3010", name: "GYAN PRAKASH YADAV", present: false },
            { id: "MGCU2023CSIT3011", name: "KARTIK SAHU", present: false },
            { id: "MGCU2023CSIT3012", name: "MONU KUMAWAT", present: false },
            { id: "MGCU2023CSIT3013", name: "NIKHIL ANAND", present: false },
            { id: "MGCU2023CSIT3014", name: "PABITRA MONDAL", present: false },
            { id: "MGCU2023CSIT3015", name: "PANKAJ KUMAR SINGH", present: false },
            { id: "MGCU2023CSIT3016", name: "PRATAP YADAV", present: false },
            { id: "MGCU2023CSIT3017", name: "PRATEEK PANDEY", present: false },
            { id: "MGCU2023CSIT3018", name: "PRIYANSHU KUMAR", present: false },
            { id: "MGCU2023CSIT3019", name: "RANJEET CHAUDHARY", present: false },
            { id: "MGCU2023CSIT3020", name: "RAVI RAJ", present: false },
            { id: "MGCU2023CSIT3021", name: "RISHABH SHUKLA", present: false },
            { id: "MGCU2023CSIT3022", name: "RIYA KUMARI", present: false },
            { id: "MGCU2023CSIT3023", name: "SANDEEP PRAJAPATI", present: false },
            { id: "MGCU2023CSIT3024", name: "SATYAM KUMAR", present: false },
            { id: "MGCU2023CSIT3025", name: "SHIVA HANSDA", present: false },
            { id: "MGCU2023CSIT3026", name: "SHRUTI GUPTA", present: false },
            { id: "MGCU2023CSIT3027", name: "SHRISTI GUPTA", present: false },
            { id: "MGCU2023CSIT3028", name: "SUDIP TIKADER", present: false },
            { id: "MGCU2023CSIT3029", name: "SWATANTRA SAHU", present: false },
            { id: "MGCU2023CSIT3030", name: "VISHAL KUMAR", present: false }
        ];

        // State
        let students = JSON.parse(JSON.stringify(initialStudents));

        // DOM Elements
        const studentListContainer = document.getElementById('student-list-container');
        const dateInput = document.getElementById('attendance-date');
        const subjectSelect = document.getElementById('subject-select');
        const presentCountEl = document.getElementById('present-count');
        const absentCountEl = document.getElementById('absent-count');
        const currentTimeEl = document.getElementById('current-time');
        const successModal = document.getElementById('success-modal');
        const loadingOverlay = document.getElementById('loading-overlay');
        const saveBtn = document.getElementById('save-btn');

        // --- Core Functions ---

        function init() {
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            
            // Set Time
            updateTime();
            setInterval(updateTime, 60000);

            // Add change listeners for loading data
            dateInput.addEventListener('change', loadAttendance);
            subjectSelect.addEventListener('change', loadAttendance);

            renderStudents();
            updateStats();
        }

        function updateTime() {
            const now = new Date();
            currentTimeEl.textContent = now.toLocaleDateString('en-IN', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' 
            });
        }

        function renderStudents() {
            studentListContainer.innerHTML = '';
            studentListContainer.appendChild(loadingOverlay); // Keep overlay in DOM
            
            students.forEach((student, index) => {
                const row = document.createElement('div');
                row.className = 'student-row grid grid-cols-12 items-center py-3 px-6 border-b border-gray-100 last:border-0 transition-colors duration-150';
                
                const isChecked = student.present ? 'checked' : '';
                const statusText = student.present ? 'Present' : 'Absent';
                const statusColor = student.present ? 'text-green-600' : 'text-red-500';

                row.innerHTML = `
                    <div class="col-span-9 sm:col-span-8 flex items-center gap-3">
                        <div class="h-10 w-10 rounded-full bg-orange-100 flex-shrink-0 flex items-center justify-center text-[#E16734] font-bold text-sm">
                            ${student.name.charAt(0)}
                        </div>
                        <div class="flex flex-col min-w-0">
                            <span class="text-sm font-bold text-gray-900 truncate leading-tight">${student.name}</span>
                            <span class="text-xs text-gray-500 font-mono truncate mt-0.5">${student.id}</span>
                        </div>
                    </div>
                    <div class="col-span-3 sm:col-span-4 flex items-center justify-end sm:justify-center">
                        <label for="student-${index}" class="flex items-center cursor-pointer relative">
                            <input type="checkbox" id="student-${index}" class="sr-only" onchange="window.toggleAttendance(${index})" ${isChecked}>
                            <div class="w-11 h-6 bg-gray-200 rounded-full border border-gray-200 toggle-bg transition-colors duration-200 ease-in-out ${student.present ? 'bg-green-500 border-green-500' : ''}"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform duration-200 ease-in-out ${student.present ? 'translate-x-5' : 'translate-x-0'}"></div>
                            <span class="ml-3 text-sm font-medium w-16 hidden sm:block ${statusColor}">${statusText}</span>
                        </label>
                    </div>
                `;
                studentListContainer.appendChild(row);
            });
        }

        function updateStats() {
            const present = students.filter(s => s.present).length;
            const absent = students.length - present;
            presentCountEl.textContent = present;
            absentCountEl.textContent = absent;
        }

        // --- Firebase Data Operations ---

        async function saveAttendance() {
            if (!currentUser) return;

            const date = dateInput.value;
            const subject = subjectSelect.value;
            const docId = `${date}_${subject.replace(/[^a-zA-Z0-9]/g, '_')}`;

            // UI Feedback
            const btnText = saveBtn.querySelector('span');
            const originalText = btnText.innerText;
            btnText.innerText = "Saving...";
            saveBtn.disabled = true;

            try {
                // Modified Path: users/{uid}/attendance/{docId}
                const docRef = doc(db, 'users', currentUser.uid, 'attendance', docId);
                
                await setDoc(docRef, {
                    date: date,
                    subject: subject,
                    students: students,
                    updatedAt: new Date().toISOString(),
                    savedBy: currentUser.email
                });

                document.getElementById('modal-date').textContent = new Date(date).toLocaleDateString('en-IN') + ' - ' + subject;
                successModal.classList.remove('hidden');

            } catch (error) {
                console.error("Error saving attendance:", error);
                alert("Failed to save attendance. Please check your internet connection.");
            } finally {
                btnText.innerText = originalText;
                saveBtn.disabled = false;
            }
        }

        async function loadAttendance() {
            if (!currentUser) return;

            const date = dateInput.value;
            const subject = subjectSelect.value;
            const docId = `${date}_${subject.replace(/[^a-zA-Z0-9]/g, '_')}`;

            loadingOverlay.classList.remove('hidden');

            try {
                // Modified Path: users/{uid}/attendance/{docId}
                const docRef = doc(db, 'users', currentUser.uid, 'attendance', docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.students) {
                        students = data.students;
                    }
                } else {
                    // Reset to default if no record exists for this date/subject
                    students = JSON.parse(JSON.stringify(initialStudents));
                }
                renderStudents();
                updateStats();

            } catch (error) {
                console.error("Error loading data:", error);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        // --- Global Functions (Exposed to Window) ---

        window.toggleAttendance = function(index) {
            students[index].present = !students[index].present;
            renderStudents(); 
            updateStats();
        }

        window.markAll = function(present) {
            students.forEach(s => s.present = present);
            renderStudents();
            updateStats();
        }

        window.saveAttendance = saveAttendance;

        window.closeModal = function() {
            successModal.classList.add('hidden');
        }

        window.downloadCSV = function() {
            const subject = subjectSelect.value;
            const date = dateInput.value;
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += `Report: MGCU Attendance\nSubject: ${subject}\nDate: ${date}\nTeacher: ${currentUser ? currentUser.displayName : 'Unknown'}\n\nRoll No,Student Name,Status\n`;
            students.forEach(s => {
                const status = s.present ? "Present" : "Absent";
                csvContent += `${s.id},${s.name},${status}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `attendance_${subject.replace(/\s+/g, '_')}_${date}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- Start ---
        init();

    </script>
</body>
</html>
