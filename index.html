<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MGCU Attendance Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Custom Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #10B981;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #10B981;
        }
        
        /* Smooth fade in */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .student-row:hover {
            background-color: #f9fafb;
        }

        /* Login Overlay Styling */
        #login-overlay {
            backdrop-filter: blur(5px);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="bg-[#E16734] text-white shadow-lg sticky top-0 z-50 flex-none">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-white p-1 rounded-md overflow-hidden h-10 w-14 flex items-center justify-center">
                        <img src="https://mgcub.ac.in/images/rotate.png" alt="MGCU Logo" class="h-full w-full object-contain">
                    </div>
                    <div>
                        <h1 class="font-bold text-lg leading-tight">MGCU</h1>
                        <p class="text-xs text-white/90">Mahatma Gandhi Central University</p>
                    </div>
                </div>
                <!-- User Profile / Logout (Visible when logged in) -->
                <div id="user-nav" class="text-right hidden items-center gap-4">
                    <div class="hidden sm:block">
                        <p class="text-sm font-medium" id="user-name">User</p>
                        <p class="text-xs text-white/80" id="user-email">email@example.com</p>
                    </div>
                    <button onclick="window.showLogoutConfirmation()" class="bg-white/20 hover:bg-white/30 p-2 rounded-full transition-colors" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Login Container (Modal Overlay) -->
    <div id="login-container" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-gray-900/50 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full text-center border border-gray-100 transform scale-100 transition-transform duration-300">
            <div class="bg-orange-50 h-20 w-20 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-university text-[#E16734] text-3xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Teacher Portal Login</h2>
            <p class="text-gray-500 mb-8">Restricted access for authorized faculty only.</p>
            
            <button onclick="window.loginWithGoogle()" class="w-full flex items-center justify-center gap-3 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 font-medium py-3 px-4 rounded-xl transition-all shadow-sm hover:shadow-md group">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6" alt="Google">
                <span class="group-hover:text-gray-900">Sign in with Google</span>
            </button>
            <p id="login-error" class="text-red-500 text-sm mt-4 hidden"></p>
        </div>
    </div>

    <!-- Main Content -->
    <main id="app-content" class="max-w-4xl mx-auto px-4 py-8 flex-grow w-full transition-all duration-500 filter blur-sm pointer-events-none select-none overflow-y-auto">
        <div class="flex justify-end mb-2 sm:hidden">
             <p class="text-xs text-gray-500" id="current-time">Loading...</p>
        </div>

        <!-- Controls Card -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6 fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-clipboard-list text-[#E16734]"></i> Class Configuration
                </h2>
                <div class="hidden sm:block text-sm text-gray-500" id="desktop-time"></div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Date Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-calendar text-gray-400"></i>
                        </div>
                        <input type="date" id="attendance-date" class="pl-10 block w-full rounded-lg border-gray-300 bg-gray-50 border focus:ring-[#E16734] focus:border-[#E16734] sm:text-sm p-2.5 shadow-sm">
                    </div>
                </div>

                <!-- Subject Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Subject</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-book text-gray-400"></i>
                        </div>
                        <select id="subject-select" class="pl-10 block w-full rounded-lg border-gray-300 bg-gray-50 border focus:ring-[#E16734] focus:border-[#E16734] sm:text-sm p-2.5 shadow-sm">
                            <option value="Computer Science">Computer Science</option>
                            <option value="Mathematics">Mathematics</option>
                            <option value="Physics">Physics</option>
                            <option value="English Literature">English Literature</option>
                            <option value="History">History</option>
                            <option value="Political Science">Political Science</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Sheet -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden fade-in" style="animation-delay: 0.1s;">
            <!-- Sheet Header -->
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center flex-wrap gap-4">
                <div>
                    <h3 class="text-lg font-bold text-gray-900">Student List</h3>
                    <p class="text-sm text-gray-500">Total: <span id="total-students">30</span></p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="bg-green-100 text-green-800 text-xs font-bold px-3 py-1 rounded-full border border-green-200">
                        Present: <span id="present-count">0</span>
                    </div>
                    <div class="bg-red-100 text-red-800 text-xs font-bold px-3 py-1 rounded-full border border-red-200">
                        Absent: <span id="absent-count">30</span>
                    </div>
                </div>
            </div>

            <!-- Table Header -->
            <div class="grid grid-cols-12 bg-gray-100 py-3 px-6 text-xs font-semibold text-gray-500 uppercase tracking-wider border-b border-gray-200">
                <div class="col-span-9 sm:col-span-8">Student Details</div>
                <div class="col-span-3 sm:col-span-4 text-right sm:text-center">Status</div>
            </div>

            <!-- Student Rows Container -->
            <div id="student-list-container" class="divide-y divide-gray-100 relative min-h-[200px]">
                <!-- Loading Overlay -->
                <div id="loading-overlay" class="absolute inset-0 bg-white/80 z-10 flex items-center justify-center hidden">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#E16734]"></div>
                </div>
                <!-- Rows will be injected here by JS -->
            </div>

            <!-- Footer Actions -->
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="flex gap-4">
                    <button onclick="window.markAll(true)" class="text-sm text-green-600 hover:text-green-800 font-medium">
                        <i class="fas fa-check-double mr-1"></i> Mark All Present
                    </button>
                    <button onclick="window.markAll(false)" class="text-sm text-red-600 hover:text-red-800 font-medium">
                        <i class="fas fa-times mr-1"></i> Mark All Absent
                    </button>
                </div>
                
                <div class="flex gap-3 w-full sm:w-auto">
                    <button onclick="window.downloadPDF()" class="flex-1 sm:flex-none justify-center items-center flex gap-2 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 px-4 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm">
                        <i class="fas fa-file-pdf text-red-500"></i> Export PDF Report
                    </button>
                    <button id="save-btn" onclick="window.saveAttendance()" class="flex-1 sm:flex-none justify-center items-center flex gap-2 bg-[#E16734] hover:bg-[#c05528] text-white px-6 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-cloud-upload-alt"></i> <span>Save Record</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black opacity-50"></div>
        <div class="bg-white rounded-lg p-6 shadow-xl z-10 max-w-sm w-full mx-4 transform transition-all scale-100">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                    <i class="fas fa-check text-green-600 text-xl"></i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900">Attendance Saved!</h3>
                <p class="text-sm text-gray-500 mt-2">
                    The attendance record for <span id="modal-date" class="font-bold"></span> has been saved to the database.
                </p>
                <div class="mt-5">
                    <button onclick="window.closeModal()" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-[#E16734] text-base font-medium text-white hover:bg-[#c05528] focus:outline-none sm:text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Logout Modal -->
    <div id="confirm-logout-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black opacity-50"></div>
        <div class="bg-white rounded-lg p-6 shadow-xl z-10 max-w-sm w-full mx-4 transform transition-all scale-100">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <i class="fas fa-sign-out-alt text-red-600 text-xl"></i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900">Confirm Logout</h3>
                <p class="text-sm text-gray-500 mt-2">
                    Are you sure you want to log out?
                </p>
                <div class="mt-5 flex gap-3">
                    <button onclick="window.closeLogoutConfirmation()" type="button" class="flex-1 inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:text-sm">
                        Cancel
                    </button>
                    <button onclick="window.confirmLogout()" type="button" class="flex-1 inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:text-sm">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- AUTH CONFIGURATION ---
        const ALLOWED_EMAILS = [
            "teacher@mgcub.ac.in", 
            "admin@mgcub.ac.in",
            "pabitramondal2635@gmail.com",
            "another.email@gmail.com",
            "faculty.member@mgcub.ac.in"
        ];
        
        const firebaseConfig = {
            apiKey: "AIzaSyC_JIo87PMLA6HdUHEpwxqvDr0L8yAs0xQ",
            authDomain: "mgcub-attendence.firebaseapp.com",
            projectId: "mgcub-attendence",
            storageBucket: "mgcub-attendence.firebasestorage.app",
            messagingSenderId: "1078820995602", 
            appId: "1:1078820995602:web:0533bb30794f2237ff4ecb",
            measurementId: "G-01LZJFL597"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null;

        // --- DOM Elements ---
        const loginContainer = document.getElementById('login-container');
        const confirmLogoutModal = document.getElementById('confirm-logout-modal');
        const appContent = document.getElementById('app-content');
        const userNav = document.getElementById('user-nav');
        const userNameEl = document.getElementById('user-name');
        const userEmailEl = document.getElementById('user-email');
        const loginErrorEl = document.getElementById('login-error');
        
        const studentListContainer = document.getElementById('student-list-container');
        const dateInput = document.getElementById('attendance-date');
        const subjectSelect = document.getElementById('subject-select');
        
        const presentCountEl = document.getElementById('present-count');
        const absentCountEl = document.getElementById('absent-count');
        const totalStudentsEl = document.getElementById('total-students');
        
        const currentTimeEl = document.getElementById('current-time');
        const desktopTimeEl = document.getElementById('desktop-time');
        const successModal = document.getElementById('success-modal');
        const loadingOverlay = document.getElementById('loading-overlay');
        const saveBtn = document.getElementById('save-btn');

        // --- Data Definitions ---
        const initialStudents = [
            { id: "MGCU2023CSIT3001", name: "AADIL LATIF", present: false },
            { id: "MGCU2023CSIT3002", name: "ADITYA PRATAP SINGH", present: false },
            { id: "MGCU2023CSIT3003", name: "AJAIN RAJ PRASHAR", present: false },
            { id: "MGCU2023CSIT3004", name: "AKASH", present: false },
            { id: "MGCU2023CSIT3005", name: "ALOK JAISWAL", present: false },
            { id: "MGCU2023CSIT3006", name: "ALOK MEHTA", present: false },
            { id: "MGCU2023CSIT3007", name: "ASHISH KUMAR1", present: false },
            { id: "MGCU2023CSIT3008", name: "ASHISH KUMAR2", present: false },
            { id: "MGCU2023CSIT3009", name: "AYUSH PANDEY", present: false },
            { id: "MGCU2023CSIT3010", name: "GYAN PRAKASH YADAV", present: false },
            { id: "MGCU2023CSIT3011", name: "KARTIK SAHU", present: false },
            { id: "MGCU2023CSIT3012", name: "MONU KUMAWAT", present: false },
            { id: "MGCU2023CSIT3013", name: "NIKHIL ANAND", present: false },
            { id: "MGCU2023CSIT3014", name: "PABITRA MONDAL", present: false },
            { id: "MGCU2023CSIT3015", name: "PANKAJ KUMAR SINGH", present: false },
            { id: "MGCU2023CSIT3016", name: "PRATAP YADAV", present: false },
            { id: "MGCU2023CSIT3017", name: "PRATEEK PANDEY", present: false },
            { id: "MGCU2023CSIT3018", name: "PRIYANSHU KUMAR", present: false },
            { id: "MGCU2023CSIT3019", name: "RANJEET CHAUDHARY", present: false },
            { id: "MGCU2023CSIT3020", name: "RAVI RAJ", present: false },
            { id: "MGCU2023CSIT3021", name: "RISHABH SHUKLA", present: false },
            { id: "MGCU2023CSIT3022", name: "RIYA KUMARI", present: false },
            { id: "MGCU2023CSIT3023", name: "SANDEEP PRAJAPATI", present: false },
            { id: "MGCU2023CSIT3024", name: "SATYAM KUMAR", present: false },
            { id: "MGCU2023CSIT3025", name: "SHIVA HANSDA", present: false },
            { id: "MGCU2023CSIT3026", name: "SHRUTI GUPTA", present: false },
            { id: "MGCU2023CSIT3027", name: "SHRISTI GUPTA", present: false },
            { id: "MGCU2023CSIT3028", name: "SUDIP TIKADER", present: false },
            { id: "MGCU2023CSIT3029", name: "SWATANTRA SAHU", present: false },
            { id: "MGCU2023CSIT3030", name: "VISHAL KUMAR", present: false }
        ];

        // State
        let students = JSON.parse(JSON.stringify(initialStudents));

        // --- Core Functions ---

        function init() {
            // Set default date to LOCAL time (fixes UTC issue)
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;
            
            // Set Time
            updateTime();
            setInterval(updateTime, 60000);

            // Add Listeners
            dateInput.addEventListener('change', loadAttendance);
            subjectSelect.addEventListener('change', loadAttendance);

            renderStudents();
            updateStats();
        }

        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleDateString('en-IN', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' 
            });
            currentTimeEl.textContent = timeString;
            if(desktopTimeEl) desktopTimeEl.textContent = timeString;
        }

        function renderStudents() {
            studentListContainer.innerHTML = '';
            studentListContainer.appendChild(loadingOverlay); // Keep overlay in DOM
            
            students.forEach((student, index) => {
                const row = document.createElement('div');
                row.className = 'student-row grid grid-cols-12 items-center py-3 px-6 border-b border-gray-100 last:border-0 transition-colors duration-150';
                
                const isChecked = student.present ? 'checked' : '';
                const statusText = student.present ? 'Present' : 'Absent';
                const statusColor = student.present ? 'text-green-600' : 'text-red-500';

                row.innerHTML = `
                    <div class="col-span-9 sm:col-span-8 flex items-center gap-3">
                        <div class="h-10 w-10 rounded-full bg-orange-100 flex-shrink-0 flex items-center justify-center text-[#E16734] font-bold text-sm">
                            ${student.name.charAt(0)}
                        </div>
                        <div class="flex flex-col min-w-0">
                            <span class="text-sm font-bold text-gray-900 truncate leading-tight">${student.name}</span>
                            <span class="text-xs text-gray-500 font-mono truncate mt-0.5">${student.id}</span>
                        </div>
                    </div>
                    <div class="col-span-3 sm:col-span-4 flex items-center justify-end sm:justify-center">
                        <label for="student-${index}" class="flex items-center cursor-pointer relative">
                            <input type="checkbox" id="student-${index}" class="sr-only" onchange="window.toggleAttendance(${index})" ${isChecked}>
                            <div class="w-11 h-6 bg-gray-200 rounded-full border border-gray-200 toggle-bg transition-colors duration-200 ease-in-out ${student.present ? 'bg-green-500 border-green-500' : ''}"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform duration-200 ease-in-out ${student.present ? 'translate-x-5' : 'translate-x-0'}"></div>
                            <span class="ml-3 text-sm font-medium w-16 hidden sm:block ${statusColor}">${statusText}</span>
                        </label>
                    </div>
                `;
                studentListContainer.appendChild(row);
            });
            
            totalStudentsEl.textContent = students.length;
        }

        function updateStats() {
            const present = students.filter(s => s.present).length;
            const absent = students.length - present;
            presentCountEl.textContent = present;
            absentCountEl.textContent = absent;
        }

        // --- Firebase Data Operations ---

        async function saveAttendance() {
            if (!currentUser) return;

            const date = dateInput.value;
            const subject = subjectSelect.value;
            const docId = `${date}_${subject.replace(/[^a-zA-Z0-9]/g, '_')}`;

            // UI Feedback
            const btnText = saveBtn.querySelector('span');
            const originalText = btnText.innerText;
            btnText.innerText = "Saving...";
            saveBtn.disabled = true;

            try {
                const docRef = doc(db, 'users', currentUser.uid, 'attendance', docId);
                
                await setDoc(docRef, {
                    date: date,
                    subject: subject,
                    students: students,
                    updatedAt: new Date().toISOString(),
                    savedBy: currentUser.email
                });

                document.getElementById('modal-date').textContent = new Date(date).toLocaleDateString('en-IN') + ' - ' + subject;
                successModal.classList.remove('hidden');

            } catch (error) {
                console.error("Error saving attendance:", error);
                alert("Failed to save attendance. Please check your internet connection.");
            } finally {
                btnText.innerText = originalText;
                saveBtn.disabled = false;
            }
        }

        async function loadAttendance() {
            if (!currentUser) return;

            const date = dateInput.value;
            const subject = subjectSelect.value;
            const docId = `${date}_${subject.replace(/[^a-zA-Z0-9]/g, '_')}`;

            loadingOverlay.classList.remove('hidden');

            try {
                const docRef = doc(db, 'users', currentUser.uid, 'attendance', docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.students) {
                        students = data.students;
                    }
                } else {
                    students = JSON.parse(JSON.stringify(initialStudents));
                }
                
                renderStudents();
                updateStats();

            } catch (error) {
                console.error("Error loading data:", error);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        // --- PDF Generation Logic ---
        
        window.downloadPDF = async function() {
            if (!currentUser) return;
            const subject = subjectSelect.value;
            const btn = document.querySelector('button[onclick="window.downloadPDF()"]');
            const originalContent = btn.innerHTML;
            
            try {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                btn.disabled = true;

                // 1. Fetch All Attendance Records for this subject
                const attendanceRef = collection(db, 'users', currentUser.uid, 'attendance');
                const q = query(attendanceRef, where("subject", "==", subject));
                const querySnapshot = await getDocs(q);
                
                const totalClasses = querySnapshot.size;
                
                if (totalClasses === 0) {
                    alert("No previous attendance records found for this subject to calculate percentage.");
                    return;
                }

                // 2. Aggregate Data
                // Initialize map with current student roster to ensure everyone is included
                const studentStats = {};
                initialStudents.forEach(s => {
                    studentStats[s.id] = {
                        name: s.name,
                        present: 0
                    };
                });

                // Iterate through history
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.students && Array.isArray(data.students)) {
                        data.students.forEach(s => {
                            if (s.present && studentStats[s.id]) {
                                studentStats[s.id].present++;
                            }
                        });
                    }
                });

                // 3. Prepare Table Data
                const tableData = Object.keys(studentStats).map(id => {
                    const stats = studentStats[id];
                    const percentageStr = totalClasses > 0 ? ((stats.present / totalClasses) * 100).toFixed(1) : "0.0";
                    const percentageVal = parseFloat(percentageStr);
                    
                    // Calculate Marks based on Percentage
                    let marks = 0;
                    if (percentageVal >= 95) marks = 5;
                    else if (percentageVal >= 90) marks = 4;
                    else if (percentageVal >= 85) marks = 3;
                    else if (percentageVal >= 80) marks = 2;
                    else if (percentageVal >= 75) marks = 1;
                    
                    return [id, stats.name, `${stats.present} / ${totalClasses}`, `${percentageStr}%`, marks];
                });

                // 4. Generate PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Header
                doc.setFontSize(22);
                doc.setTextColor(225, 103, 52); // #E16734
                doc.text("MGCU Attendance Report", 14, 20);
                
                doc.setFontSize(11);
                doc.setTextColor(100);
                doc.text(`Subject: ${subject}`, 14, 30);
                doc.text(`Total Classes Conducted: ${totalClasses}`, 14, 36);
                doc.text(`Generated on: ${new Date().toLocaleDateString('en-IN', { dateStyle: 'full' })}`, 14, 42);

                // Table
                doc.autoTable({
                    startY: 50,
                    head: [['Enrollment No', 'Student Name', 'Attendance (P/Total)', 'Percentage', 'Marks']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [225, 103, 52], 
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    styles: { 
                        fontSize: 10, 
                        cellPadding: 4,
                        valign: 'middle'
                    },
                    columnStyles: {
                        0: { fontStyle: 'bold' }, // ID
                        3: { halign: 'right' },    // Percentage
                        4: { halign: 'center', fontStyle: 'bold' } // Marks centered
                    },
                    alternateRowStyles: { fillColor: [255, 247, 237] } // Light orange tint
                });

                doc.save(`Attendance_Report_${subject.replace(/\s+/g, '_')}.pdf`);

            } catch (error) {
                console.error("Error generating PDF:", error);
                alert("Failed to generate PDF. See console for details.");
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        // --- Global Functions (Exposed to Window) ---

        window.toggleAttendance = function(index) {
            students[index].present = !students[index].present;
            renderStudents(); 
            updateStats();
        }

        window.markAll = function(present) {
            students.forEach(s => s.present = present);
            renderStudents();
            updateStats();
        }

        window.saveAttendance = saveAttendance;

        window.closeModal = function() {
            successModal.classList.add('hidden');
        }

        // Kept for backward compatibility if needed, though hidden in UI
        window.downloadCSV = function() {
            const subject = subjectSelect.value;
            const date = dateInput.value;
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += `Report: MGCU Attendance\nSubject: ${subject}\nDate: ${date}\nTeacher: ${currentUser ? currentUser.displayName : 'Unknown'}\n\nRoll No,Student Name,Status\n`;
            students.forEach(s => {
                const status = s.present ? "Present" : "Absent";
                csvContent += `${s.id},${s.name},${status}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `attendance_${subject.replace(/\s+/g, '_')}_${date}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.showLogoutConfirmation = function() {
            confirmLogoutModal.classList.remove('hidden');
        }

        window.closeLogoutConfirmation = function() {
            confirmLogoutModal.classList.add('hidden');
        }

        window.confirmLogout = function() {
            window.closeLogoutConfirmation();
            window.logout();
        }

        window.loginWithGoogle = async function() {
            loginErrorEl.classList.add('hidden');
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                if (ALLOWED_EMAILS.includes(user.email)) {
                    console.log("Login successful");
                } else {
                    await signOut(auth);
                    loginErrorEl.textContent = `Access Denied: ${user.email} is not authorized.`;
                    loginErrorEl.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Login Failed:", error);
                loginErrorEl.textContent = "Login failed. Please try again.";
                loginErrorEl.classList.remove('hidden');
            }
        };

        window.logout = function() {
            signOut(auth).catch((error) => console.error("Logout Error:", error));
        };

        onAuthStateChanged(auth, (user) => {
            if (user && ALLOWED_EMAILS.includes(user.email)) {
                currentUser = user;
                loginContainer.classList.add('hidden');
                appContent.classList.remove('filter', 'blur-sm', 'pointer-events-none', 'select-none');
                document.body.classList.remove('overflow-hidden');
                userNav.classList.replace('hidden', 'flex');
                userNameEl.textContent = user.displayName;
                userEmailEl.textContent = user.email;
                loadAttendance();
            } else {
                currentUser = null;
                loginContainer.classList.remove('hidden');
                appContent.classList.add('filter', 'blur-sm', 'pointer-events-none', 'select-none');
                document.body.classList.add('overflow-hidden');
                userNav.classList.replace('flex', 'hidden');
            }
        });

        // --- Start ---
        init();

    </script>
</body>
</html>
